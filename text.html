<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WISP Proxy Ready</title>
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
#bar { display:flex; padding:6px; background:#222; }
#url { flex:1; padding:6px; border:none; border-radius:4px; }
#go { margin-left:6px; padding:6px 12px; border:none; background:#4cafef; color:#fff; border-radius:4px; cursor:pointer; }
#viewer { width:100%; height:calc(100vh - 42px); border:none; background:#222; display:flex; align-items:center; justify-content:center; color:#fff; font-size:1.2em; text-align:center; }
#status { padding:6px; background:#444; color:#fff; font-size:0.9em; text-align:center; }
</style>
</head>
<body>
<div id="bar">
<input id="url" type="text" placeholder="https://example.com">
<button id="go">Go</button>
</div>
<div id="status">WebSocket status: Not connected</div>
<div id="viewer">
Enter a URL above and click Go or press Enter.
</div>

<script>
const WISP_URL = "wss://wisp.mercurywork.shop/"; // Change to your backend if needed
const urlBox = document.getElementById("url");
const goBtn = document.getElementById("go");
const viewer = document.getElementById("viewer");
const statusDiv = document.getElementById("status");

let ws;
let connected = false;

// Connect to WISP backend
function connectWisp(cb){
    if(ws && ws.readyState === WebSocket.OPEN) return cb();
    statusDiv.textContent = "WebSocket status: Connecting...";
    ws = new WebSocket(WISP_URL);
    ws.onopen = () => { connected = true; statusDiv.textContent = "WebSocket status: Connected"; cb(); };
    ws.onmessage = ev => handleResponse(ev.data);
    ws.onerror = e => { connected = false; statusDiv.textContent = "WebSocket status: Connection failed"; console.error("WebSocket error:", e); };
    ws.onclose = () => { connected = false; statusDiv.textContent = "WebSocket status: Closed"; };
}

const pendingRequests = {};
let requestCounter = 0;

// Send a fetch request via WISP
function sendFetch(target){
    return new Promise(resolve=>{
        connectWisp(()=>{
            const id = requestCounter++;
            pendingRequests[id] = resolve;
            ws.send(JSON.stringify({id, action:"fetch", url:target}));
        });
    });
}

// Handle responses from WISP
function handleResponse(data){
    let obj;
    try { obj = JSON.parse(data); } catch(e){ return; }
    if(obj.id !== undefined && pendingRequests[obj.id]){
        const body = obj.body || (obj.body_b64 ? atob(obj.body_b64) : "");
        viewer.innerHTML = `<iframe sandbox="allow-scripts allow-forms allow-same-origin" style="width:100%;height:100%;border:none;"></iframe>`;
        const iframeDoc = viewer.firstElementChild.contentDocument || viewer.firstElementChild.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(body);
        iframeDoc.close();
        pendingRequests[obj.id]();
        delete pendingRequests[obj.id];
    }
}

// Go button / Enter key
function go(){
    const target = urlBox.value.trim();
    if(!target.startsWith("http")) return alert("Enter full URL including http/https");
    if(!connected){
        viewer.innerHTML = `<p>Connecting to WISP backend...</p>`;
    }
    sendFetch(target);
}

goBtn.addEventListener("click", go);
urlBox.addEventListener("keydown", e=>{
    if(e.key==="Enter"){
        e.preventDefault();
        go();
    }
});
</script>
</body>
</html>
