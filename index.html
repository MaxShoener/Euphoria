<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CORS Proxy New Tab</title>
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
#bar { display:flex; padding:6px; background:#222; }
#url { flex:1; padding:6px; border:none; border-radius:4px; }
#go { margin-left:6px; padding:6px 12px; border:none; background:#4cafef; color:#fff; border-radius:4px; cursor:pointer; }
#status { padding:6px; background:#444; color:#fff; font-size:0.9em; text-align:center; }
</style>
</head>
<body>
<div id="bar">
<input id="url" type="text" placeholder="https://example.com">
<button id="go">Go</button>
</div>
<div id="status">Enter a URL and click Go or press Enter.</div>

<script>
const urlBox = document.getElementById("url");
const goBtn = document.getElementById("go");
const statusDiv = document.getElementById("status");
const CORS_PROXY = "https://cors-anywhere.herokuapp.com/";

// Function to rewrite relative URLs to go through the proxy
function rewriteUrls(html, baseUrl) {
    return html.replace(
        /(src|href)=["']([^"':]+)["']/gi,
        (match, attr, val) => {
            try {
                const absoluteUrl = new URL(val, baseUrl).href;
                return `${attr}="${CORS_PROXY}${absoluteUrl}"`;
            } catch(e) {
                return match; // leave as is if invalid URL
            }
        }
    );
}

// Load the site via proxy and open in a new tab
async function loadSite(url) {
    if (!url.startsWith("http")) url = "https://" + url;
    statusDiv.textContent = "Fetching site via proxy...";

    // Open new tab immediately to avoid popup blocking
    const newTab = window.open("", "_blank");
    if (!newTab) {
        alert("Popup blocked! Allow popups for this site.");
        return;
    }
    newTab.document.write("<p style='color:yellow;'>Loading site...</p>");

    try {
        const response = await fetch(CORS_PROXY + url);
        let html = await response.text();
        html = rewriteUrls(html, url);

        newTab.document.open();
        newTab.document.write(html);
        newTab.document.close();
        statusDiv.textContent = "Site opened in new tab (proxied)";
    } catch (e) {
        statusDiv.textContent = "Failed to load site: " + e;
        newTab.document.open();
        newTab.document.write("<p style='color:red;'>Failed to load site: " + e + "</p>");
        newTab.document.close();
    }
}

// Event listeners
goBtn.addEventListener("click", () => {
    const target = urlBox.value.trim();
    if (!target) return alert("Enter a URL");
    loadSite(target);
});

urlBox.addEventListener("keydown", e => {
    if(e.key === "Enter") {
        e.preventDefault();
        goBtn.click();
    }
});
</script>
</body>
</html>
