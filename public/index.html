<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Euphoria</title>
<style>
  :root {
    --bg: #0b0c0d;
    --topbar-bg: rgba(16,18,20,0.95);
    --muted: #9aa0a6;
    --accent: #2e7d32;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#070809 0%, #0f1113 100%);font-family:system-ui,Arial,sans-serif;color:#fff;overflow:hidden}
  /* Floating oval top bar */
  #topbar {
    position:fixed;
    top:12px;
    left:50%;
    transform:translateX(-50%);
    width:88%;
    max-width:1200px;
    background: var(--topbar-bg);
    border-radius:999px;
    padding:10px 14px;
    display:flex;
    align-items:center;
    gap:10px;
    z-index:9999;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
  }
  #topbar button {
    min-width:46px;
    padding:8px;
    border-radius:12px;
    border:0;
    background:#141617;
    color:#fff;
    cursor:pointer;
    font-size:14px;
  }
  #address {
    flex:1;
    padding:10px 14px;
    border-radius:18px;
    border:0;
    background:#0c0d0e;
    color:#fff;
    font-size:14px;
    outline:none;
  }
  #go {
    background:var(--accent);
  }
  /* main content area - we will inject content here */
  #content {
    position:absolute;
    top:72px;
    bottom:12px;
    left:12px;
    right:12px;
    border-radius:12px;
    overflow:auto;
    background: #f6f7f8; /* server-injected pages will override backgrounds, we set neutral */
    box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  }
  /* spinner overlay */
  #spinner {
    position:fixed;
    top:72px;
    left:12px;
    right:12px;
    bottom:12px;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9998;
    background: rgba(0,0,0,0.4);
    border-radius:12px;
    pointer-events:none;
  }
  .spinner-anim {
    width:46px;height:46px;border-radius:50%;border:6px solid rgba(255,255,255,0.12);border-top-color:var(--accent);animation:spin 900ms linear infinite;
  }
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  /* message box for errors */
  .msg {
    padding:20px;color:#fff;background:rgba(0,0,0,0.6);border-radius:12px;display:inline-block;
  }
</style>
</head>
<body>

<div id="topbar" role="toolbar" aria-label="Euphoria top bar">
  <button id="back">‚óÄ</button>
  <button id="forward">‚ñ∂</button>
  <button id="refresh">‚ü≥</button>
  <button id="home">üè†</button>
  <input id="address" placeholder="Enter URL or search (eg. google.com or xbox.com or 'how to play baseball')" />
  <button id="go">Go</button>
  <button id="fullscreen">‚õ∂</button>
</div>

<div id="spinner"><div class="spinner-anim" role="status" aria-hidden="true"></div></div>

<!-- content will be the proxied HTML returned by /proxy -->
<div id="content">
  <!-- initial content -->
  <div style="padding:36px;text-align:center;color:#222">
    <h2 style="margin:0 0 12px 0">Welcome to Euphoria</h2>
    <p style="margin:0 0 18px 0;color:#444">Type an address in the top bar and hit Go or Enter. Navigation stays inside Euphoria.</p>
    <p style="color:#888">Example: <code>google.com</code>, <code>xbox.com</code>, or <code>how to bake sourdough</code></p>
  </div>
</div>

<script>
(() => {
  const address = document.getElementById('address');
  const go = document.getElementById('go');
  const back = document.getElementById('back');
  const forward = document.getElementById('forward');
  const refresh = document.getElementById('refresh');
  const home = document.getElementById('home');
  const fullscreen = document.getElementById('fullscreen');
  const spinner = document.getElementById('spinner');
  const content = document.getElementById('content');

  function showSpinner() { spinner.style.display = 'flex'; }
  function hideSpinner() { spinner.style.display = 'none'; }

  function isLikelySearch(v) {
    if (!v) return true;
    if (v.includes(' ')) return true;
    if (/^https?:\/\//i.test(v)) return false;
    if (/\./.test(v)) return false;
    return true;
  }

  function normalizeInput(v) {
    v = (v || '').trim();
    if (!v) return 'https://www.google.com';
    if (isLikelySearch(v)) return 'https://www.google.com/search?q=' + encodeURIComponent(v);
    if (/^https?:\/\//i.test(v)) return v;
    return 'https://' + v;
  }

  // Load via /proxy?url=... ‚Äî server will return rewritten HTML with injected topbar and containment
  async function loadUrl(raw) {
    const url = normalizeInput(raw);
    const prox = '/proxy?url=' + encodeURIComponent(url);
    showSpinner();
    try {
      const res = await fetch(prox, { credentials: 'same-origin' });
      if (!res.ok) {
        const text = await res.text().catch(()=>res.statusText);
        content.innerHTML = '<div class="msg">Error loading page: ' + res.status + ' ‚Äî ' + (text || res.statusText) + '</div>';
        hideSpinner();
        return;
      }
      // response is complete HTML; replace content area with it
      const html = await res.text();
      // Replace content's innerHTML with proxied HTML body ‚Äî server injected topbar ensures nav, but we still strip html/head tags
      // We'll attempt to extract <body> content
      const bodyMatch = html.match(/<body[^>]*>([\\s\\S]*?)<\\/body>/i);
      if (bodyMatch) {
        content.innerHTML = bodyMatch[1];
      } else {
        content.innerHTML = html;
      }

      // After injecting remote content into #content, run a small pass to remove any scripts that might break our page (best-effort)
      // But we rely on server-side rewriting for links/assets; here we just ensure inputs triggered in topbar work
      hideSpinner();

    } catch (err) {
      content.innerHTML = '<div class="msg">Network / proxy error: ' + (err && err.message ? err.message : err) + '</div>';
      hideSpinner();
    }
  }

  // Wiring topbar
  go.addEventListener('click', () => loadUrl(address.value));
  address.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadUrl(address.value); });
  back.addEventListener('click', () => history.back());
  forward.addEventListener('click', () => history.forward());
  refresh.addEventListener('click', () => location.reload());
  home.addEventListener('click', () => { address.value = 'https://www.google.com'; loadUrl(address.value); });
  fullscreen.addEventListener('click', () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  // If URL param given: /?proxy=... or /?url=..., auto-load
  (function loadFromQuery(){
    try {
      const sp = new URLSearchParams(location.search);
      const u = sp.get('url') || sp.get('proxy') || sp.get('q') || '';
      if (u) {
        address.value = decodeURIComponent(u);
        loadUrl(address.value);
      }
    } catch(e){}
  })();

  // Make topbar usable while spinner visible ‚Äî spinner is pointer-events:none in CSS.
  // Provide a small ping endpoint to warm server
  fetch('/healthz').catch(()=>{});
})();
</script>

</body>
</html>