<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Euphoria</title>
<style>
  :root {
    --bg:#0b0b0b; --top:#111; --muted:#999; --accent:#2e7d32;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,Segoe UI,Arial;}
  /* floating oval top bar */
  #topbar {
    position:fixed; top:12px; left:50%; transform:translateX(-50%);
    width:88%; max-width:1200px; background:var(--top); border-radius:28px;
    padding:10px 12px; display:flex; gap:8px; align-items:center; z-index:2147483647;
    box-shadow:0 8px 28px rgba(0,0,0,0.6);
  }
  .btn {
    background:#1e1e1e; border:0; color:#fff; padding:8px 12px; border-radius:12px;
    min-width:44px; cursor:pointer; font-size:15px;
  }
  .btn.positive { background:var(--accent); }
  #address { flex:1; background:#141414; border-radius:12px; border:0; padding:9px 12px; color:#fff; }
  #address::placeholder { color:#777; }
  /* content area */
  #content { position:absolute; left:0; right:0; top:64px; bottom:0; overflow:auto; padding:18px; box-sizing:border-box; }
  .spinnerWrap { position:fixed; top:64px; left:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:999; pointer-events:none; }
  .spinner { width:42px;height:42px;border-radius:50%;border:6px solid #222;border-top-color:var(--accent); animation:spin 1s linear infinite; }
  @keyframes spin { from { transform:rotate(0) } to { transform:rotate(360deg) } }
  /* proxied content should appear on light background to resemble real page */
  .pageWrap { background:#fff;color:#111;border-radius:10px;padding:12px; min-height:600px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
</style>
</head>
<body>
  <div id="topbar" role="navigation" aria-label="Euphoria top bar">
    <button class="btn" id="back">‚óÄ</button>
    <button class="btn" id="forward">‚ñ∂</button>
    <button class="btn" id="refresh">‚ü≥</button>
    <button class="btn" id="home">üè†</button>
    <input id="address" placeholder="Enter URL or search (press Enter)" aria-label="Address or search"/>
    <button class="btn positive" id="go">Go</button>
    <button class="btn" id="fullscreen">‚õ∂</button>
  </div>

  <div class="spinnerWrap" id="spinnerWrap"><div class="spinner"></div></div>

  <main id="content">
    <!-- proxied HTML will be injected into pageWrap -->
    <div id="pageWrap" class="pageWrap">Welcome to Euphoria ‚Äî enter a URL or search above.</div>
  </main>

<script>
(function(){
  const address = document.getElementById('address');
  const go = document.getElementById('go');
  const back = document.getElementById('back');
  const forward = document.getElementById('forward');
  const refresh = document.getElementById('refresh');
  const home = document.getElementById('home');
  const full = document.getElementById('fullscreen');
  const spinnerWrap = document.getElementById('spinnerWrap');
  const pageWrap = document.getElementById('pageWrap');

  // client-side simple session & history
  let historyStack = [];
  let historyIndex = -1;

  function showSpinner(on=true){ spinnerWrap.style.display = on ? 'flex' : 'none'; }
  function normalizeInput(v){
    v = (v||'').trim();
    if(!v) return 'https://www.google.com';
    if(v.includes(' ') || (!v.includes('.') && !v.startsWith('http'))) return 'https://www.google.com/search?q=' + encodeURIComponent(v);
    if(!/^https?:\/\//i.test(v)) v = 'https://' + v;
    return v;
  }

  async function loadURL(url, pushHistory=true){
    showSpinner(true);
    try {
      // fetch proxied HTML
      const res = await fetch('/proxy?url=' + encodeURIComponent(url), { credentials: 'include' });
      if (!res.ok) throw new Error('Load failed: ' + res.status + ' ' + res.statusText);
      const html = await res.text();
      // Put markup into pageWrap safely
      pageWrap.innerHTML = html;
      // Update address (store the canonical url)
      const canonical = url;
      address.value = canonical;
      if (pushHistory) {
        historyStack = historyStack.slice(0, historyIndex + 1);
        historyStack.push(canonical);
        historyIndex++;
      }
      // Small delay then re-enable rewriting by injected containment script (injected by server)
      setTimeout(()=>{ try { /* nothing - server-side injection rewrites anchors/assets */ } catch(e) {} }, 200);
    } catch (err) {
      pageWrap.innerHTML = `<div style="padding:2rem;color:#900;background:#fff;border-radius:8px;">Error loading page:<br>${String(err)}</div>`;
      console.error(err);
    } finally {
      showSpinner(false);
    }
  }

  // navigation buttons
  back.onclick = () => { if (historyIndex > 0) { historyIndex--; loadURL(historyStack[historyIndex], false); } };
  forward.onclick = () => { if (historyIndex < historyStack.length - 1) { historyIndex++; loadURL(historyStack[historyIndex], false); } };
  refresh.onclick = () => { if (historyIndex >= 0) loadURL(historyStack[historyIndex], false); };
  home.onclick = () => { loadURL('https://www.google.com'); };
  full.onclick = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };

  function doGo(){
    const v = normalizeInput(address.value);
    loadURL(v);
  }
  go.onclick = doGo;
  address.addEventListener('keydown', (e)=> { if (e.key === 'Enter') doGo(); });

  // Autofill (basic, calls /autocomplete which server can provide)
  let afTimer = 0;
  address.addEventListener('input', (e)=>{
    clearTimeout(afTimer);
    afTimer = setTimeout(async ()=>{
      const q = address.value.trim();
      if (!q) return;
      try {
        const r = await fetch('/autocomplete?q=' + encodeURIComponent(q));
        if (!r.ok) return;
        const suggestions = await r.json();
        // Show tiny suggestion dropdown (simple)
        let dd = document.getElementById('eph-sugg');
        if (!dd) { dd = document.createElement('div'); dd.id='eph-sugg'; dd.style.position='absolute'; dd.style.background='#111'; dd.style.color='#fff'; dd.style.border='1px solid #222'; dd.style.zIndex=999999; dd.style.padding='6px'; dd.style.borderRadius='8px'; dd.style.marginTop='6px'; dd.style.left = (address.getBoundingClientRect().left) + 'px'; document.body.appendChild(dd); }
        dd.innerHTML = suggestions.slice(0,6).map(s=>`<div style="padding:6px;cursor:pointer" data-val="${s}">${s}</div>`).join('');
        dd.querySelectorAll('div').forEach(el=>el.onclick = ()=> { address.value = el.dataset.val; dd.remove(); doGo(); });
        setTimeout(()=>{ try{ dd.remove(); } catch(e){} }, 8000);
      } catch(e){}
    }, 250);
  });

  // initial load
  loadURL('https://www.google.com');

  // make topbar usable when spinner is on (spinner pointer-events none used)
  spinnerWrap.style.pointerEvents = 'none';
})();
</script>
</body>
</html>
