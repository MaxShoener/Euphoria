<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Euphoria</title>
<style>
  :root { --bg:#0b0c0d; --bar:#111; --muted:#999; --accent:#2e7d32; }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  /* floating oval top bar */
  .topbar {
    position:fixed; top:12px; left:50%; transform:translateX(-50%);
    width:84%; max-width:1200px; background:var(--bar); border-radius:28px;
    padding:8px 12px; box-shadow:0 10px 30px rgba(0,0,0,0.6); display:flex; gap:8px; align-items:center;
    z-index:9999;
  }
  .topbar button {
    min-width:44px; padding:8px; border-radius:12px; border:0; background:#161718; color:#fff; cursor:pointer;
    font-size:14px;
  }
  .topbar .go { background:var(--accent); }
  .topbar input {
    flex:1; padding:8px 12px; border-radius:12px; border:0; outline:none; background:#141516; color:#fff; font-size:14px;
  }
  main.content { position:fixed; top:76px; bottom:0; left:8px; right:8px; overflow:auto; background:transparent; border-radius:8px; }
  .placeholder { height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:18px; }
  /* spinner */
  .spinnerWrap { position:fixed; top:76px; left:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:998; pointer-events:none; }
  .spinner { width:48px; height:48px; border-radius:50%; border:6px solid rgba(255,255,255,0.08); border-top-color:#2e7d32; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  /* ensure injected pages visually sit nicely */
  .proxied { width:100%; min-height:80vh; background:transparent; color:#000; }
  /* small responsive tweak */
  @media (max-width:600px){ .topbar { width:calc(100% - 16px); } .topbar button{padding:6px} }
</style>
</head>
<body>
  <div class="topbar" role="navigation" aria-label="Euphoria topbar">
    <button id="back" title="Back">‚óÄ</button>
    <button id="forward" title="Forward">‚ñ∂</button>
    <button id="refresh" title="Refresh">‚ü≥</button>
    <button id="home" title="Home">üè†</button>
    <input id="address" placeholder="Enter URL or search (e.g. google.com or 'xbox remote play')" />
    <button id="go" class="go" title="Go">Go</button>
    <button id="fullscreen" title="Fullscreen">‚õ∂</button>
  </div>

  <div class="spinnerWrap" id="spinnerWrap"><div class="spinner"></div></div>

  <main class="content" id="content">
    <div class="placeholder" id="placeholder">Welcome to Euphoria ‚Äî enter a URL or search above and press Enter / Go.</div>
  </main>

<script>
  (function(){
    const address = document.getElementById('address');
    const goBtn = document.getElementById('go');
    const backBtn = document.getElementById('back');
    const forwardBtn = document.getElementById('forward');
    const refreshBtn = document.getElementById('refresh');
    const homeBtn = document.getElementById('home');
    const fullBtn = document.getElementById('fullscreen');
    const content = document.getElementById('content');
    const placeholder = document.getElementById('placeholder');
    const spinnerWrap = document.getElementById('spinnerWrap');

    let historyStack = [];
    let historyIndex = -1;

    function showSpinner(){ spinnerWrap.style.display = 'flex'; }
    function hideSpinner(){ spinnerWrap.style.display = 'none'; }

    function isLikelySearch(v){
      if(!v) return true;
      if(v.indexOf(' ') !== -1) return true;
      if(/^https?:\\/\\//i.test(v)) return false;
      if(/\\./.test(v)) return false;
      return true;
    }
    function normalize(v){
      v = (v||'').trim();
      if(!v) return 'https://www.google.com';
      if(isLikelySearch(v)) return 'https://www.google.com/search?q=' + encodeURIComponent(v);
      if(/^https?:\\/\\//i.test(v)) return v;
      return 'https://' + v;
    }

    async function loadUrl(url, pushHistory=true){
      try {
        showSpinner();
        // fetch proxied HTML
        const prox = '/proxy?url=' + encodeURIComponent(url);
        const res = await fetch(prox, { credentials: 'include' });
        if(!res.ok) throw new Error('Load failed: ' + res.status);
        const html = await res.text();

        // create container div to hold proxied HTML
        const wrapper = document.createElement('div');
        wrapper.className = 'proxied';
        // set innerHTML (this contains the injected topbar from server too but server already injects containment script)
        wrapper.innerHTML = html;

        // remove previous content
        content.innerHTML = '';
        content.appendChild(wrapper);

        // update address input (server-side final URL is provided as base href so location might not reflect; keep our url)
        address.value = url;

        // push history
        if(pushHistory){
          historyStack = historyStack.slice(0, historyIndex + 1);
          historyStack.push(url);
          historyIndex++;
        }
        hideSpinner();

      } catch (err) {
        hideSpinner();
        content.innerHTML = '<div class="placeholder" style="color:#f66">Error loading page:<br>' + String(err) + '</div>';
      }
    }

    // nav button wiring
    backBtn.onclick = () => { if(historyIndex > 0) loadUrl(historyStack[--historyIndex], false); };
    forwardBtn.onclick = () => { if(historyIndex < historyStack.length - 1) loadUrl(historyStack[++historyIndex], false); };
    refreshBtn.onclick = () => { if(historyIndex >= 0) loadUrl(historyStack[historyIndex], false); };
    homeBtn.onclick = () => loadUrl('https://www.google.com');
    fullBtn.onclick = () => { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };

    function doSearchGo(){ const val = address.value; const u = normalize(val); loadUrl(u); }
    goBtn.onclick = doSearchGo;
    address.addEventListener('keydown', e => { if(e.key === 'Enter') doSearchGo(); });

    // simple autofill from recent (localStorage)
    const REC_KEY = 'euphoria_recent';
    function saveRecent(url){
      try{
        let list = JSON.parse(localStorage.getItem(REC_KEY) || '[]');
        list = list.filter(x=>x!==url);
        list.unshift(url);
        if(list.length > 20) list.pop();
        localStorage.setItem(REC_KEY, JSON.stringify(list));
      }catch(e){}
    }
    // optional simple suggestion dropdown (minimal)
    address.addEventListener('input', e=>{
      try{
        const q = address.value.toLowerCase();
        const list = JSON.parse(localStorage.getItem(REC_KEY)||'[]') || [];
        // if you want, add UI to show suggestions ‚Äî omitted for brevity
      }catch(e){}
    });

    // ensure deep links (if user opens /?url=...) load
    (function initFromQuery(){
      try{
        const m = location.search.match(/[?&]url=([^&]+)/);
        if(m){
          const u = decodeURIComponent(m[1]);
          address.value = u;
          loadUrl(u);
        } else {
          // initial home page
          address.value = 'https://www.google.com';
          loadUrl('https://www.google.com');
        }
      }catch(e){
        address.value = 'https://www.google.com';
        loadUrl('https://www.google.com');
      }
    })();

    // maintain local history array when user navigates inside proxied DOM by clicking proxied anchors:
    // since server injects containment script that re-routes anchors to /proxy?url=..., clicking those links will change our location; handle popstate
    window.addEventListener('popstate', () => {
      const m = location.search.match(/[?&]url=([^&]+)/);
      if(m){ const u = decodeURIComponent(m[1]); address.value = u; loadUrl(u, false); }
    });

    // ensure topbar remains interactive even while proxied page has heavy overlays ‚Äî keep pointer-events enabled on topbar by CSS (done)
  })();
</script>
</body>
</html>
