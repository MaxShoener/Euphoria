<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euphoria v2</title>

    <style>
        /* ---------------- GLOBAL RESET ---------------- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0d0d0d; color: white; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; overflow: hidden; }

        /* ---------------- TOP BAR ---------------- */
        #topbar { position: fixed; top: 0; left: 0; width: 100%; height: 52px;
            backdrop-filter: blur(14px) saturate(160%);
            background: rgba(20,20,20,0.45); border-bottom: 1px solid rgba(255,255,255,0.12);
            display: flex; align-items: center; padding: 0 14px; z-index: 9999;
        }

        .nav-btn { width:36px;height:36px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.08); color:white; display:flex; align-items:center; justify-content:center;
            font-size:18px; cursor:pointer; margin-right:10px; user-select:none; transition:0.18s ease background,border;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.32); }

        #urlInput { flex-grow:1;height:38px;border-radius:10px;border:1px solid rgba(255,255,255,0.22);
            background: rgba(255,255,255,0.10); padding:0 15px;font-size:15px;color:white; outline:none;
        }
        #urlInput:focus { border:1px solid rgba(255,255,255,0.45); background: rgba(255,255,255,0.15); }

        /* ---------------- MAIN VIEW ---------------- */
        #view { position:absolute; top:52px; left:0; width:100%; height:calc(100% - 52px); background:#111; overflow:auto; }
        #view.fade { opacity:0; transition:opacity 0.25s ease-out; }

        /* ---------------- LOADING SPINNER ---------------- */
        #spinner { position:absolute; top:50%; left:50%; width:60px;height:60px; transform:translate(-50%,-50%);
            border-radius:50%; border:6px solid rgba(255,255,255,0.15); border-top-color:#fff;
            animation: spin 0.8s linear infinite; display:none; z-index:5000;
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        #viewContent { padding:0; }
    </style>
</head>
<body>

    <!-- TOP BAR -->
    <div id="topbar">
        <div class="nav-btn" id="backBtn">←</div>
        <div class="nav-btn" id="forwardBtn">→</div>
        <div class="nav-btn" id="reloadBtn">⟳</div>
        <div class="nav-btn" id="homeBtn">⌂</div>
        <input id="urlInput" placeholder="Enter a URL (https://…)" />
    </div>

    <!-- LOADING SPINNER -->
    <div id="spinner"></div>

    <!-- MAIN VIEW -->
    <div id="view">
        <div id="viewContent"></div>
    </div>

    <script>
        const view = document.getElementById("viewContent");
        const spinner = document.getElementById("spinner");
        const input = document.getElementById("urlInput");

        let historyStack = [];
        let historyIndex = -1;

        function go(url, push = true) {
            if (!url.startsWith("http")) url = "https://" + url;
            input.value = url;
            if (push) {
                historyStack = historyStack.slice(0, historyIndex + 1);
                historyStack.push(url);
                historyIndex++;
            }
            loadPage(url);
        }

        function goHome() { go("https://www.google.com", true); }

        async function loadPage(url) {
            spinner.style.display = "block";
            view.innerHTML = "";
            view.classList.add("fade");

            const proxyURL = `/proxy?url=${encodeURIComponent(url)}`;
            try {
                const response = await fetch(proxyURL, { headers:{ "X-Euphoria-Client":"v2" } });
                const text = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(text,"text/html");

                // Clear current content and inject head elements
                document.head.innerHTML = "";
                doc.head.childNodes.forEach(node => document.head.appendChild(document.importNode(node,true)));

                // Inject body content
                view.innerHTML = "";
                doc.body.childNodes.forEach(node => view.appendChild(document.importNode(node,true)));

                // Dynamically execute scripts
                const scripts = view.querySelectorAll("script");
                scripts.forEach(oldScript => {
                    const newScript = document.createElement("script");
                    if (oldScript.src) newScript.src = oldScript.src;
                    else newScript.textContent = oldScript.textContent;
                    oldScript.replaceWith(newScript);
                });

            } catch(e) {
                view.innerHTML = `<pre style="padding:20px;color:#ff8080;">Error loading page: ${e}</pre>`;
            } finally {
                spinner.style.display = "none";
                view.classList.remove("fade");
            }
        }

        // Navigation buttons
        document.getElementById("backBtn").onclick = () => { if(historyIndex>0){historyIndex--;go(historyStack[historyIndex],false);} };
        document.getElementById("forwardBtn").onclick = () => { if(historyIndex<historyStack.length-1){historyIndex++;go(historyStack[historyIndex],false);} };
        document.getElementById("reloadBtn").onclick = () => { go(historyStack[historyIndex],false); };
        document.getElementById("homeBtn").onclick = goHome;

        input.addEventListener("keydown",e=>{ if(e.key==="Enter") go(input.value); });

        goHome();
    </script>

</body>
</html>