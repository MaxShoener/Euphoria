<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Euphoria Wisp UI</title>
  <style>
    :root{--bg:#0b0e13;--panel:#0f1720;--muted:#9aa4b2;--accent:#4f46e5;--danger:#e11d48}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021,#0b1220);font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .app{max-width:1100px;margin:28px auto;padding:20px;color:#e6eef6}
    .header{display:flex;gap:12px;align-items:center}
    .logo{font-weight:700;font-size:20px;letter-spacing:.6px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    input[type="text"]{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:#e6eef6;min-width:300px}
    button{background:var(--accent);border:0;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .frame-wrap{margin-top:18px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    #targetFrame{width:100%;height:72vh;border:0;background:white}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .small{font-size:13px;color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .bad{color:var(--danger)}
    .server-select{display:flex;gap:8px;align-items:center}
    label{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app" role="application">
    <div class="header">
      <div class="logo">Euphoria — Wisp UI</div>
      <div class="server-select" style="margin-left:16px">
        <label for="wispUrl">Wisp server</label>
        <input id="wispUrl" type="text" placeholder="https://your-wisp.example.com" />
        <button id="saveServer" class="ghost">Save</button>
      </div>
      <div class="controls">
        <input id="rawUrl" type="text" placeholder="https://example.com or /proxy//host/path" />
        <button id="go">Load</button>
        <button id="openNew" title="Open in new tab">Open</button>
      </div>
    </div>

    <div class="hint">Tip: paste a full URL (https://...) or a proxied path. Server setting controls the Wisp backend used by the client.</div>

    <div class="frame-wrap">
      <iframe id="targetFrame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"></iframe>
    </div>

    <div class="toolbar" style="margin-top:10px">
      <button id="back" class="ghost">Back</button>
      <button id="forward" class="ghost">Forward</button>
      <button id="reload" class="ghost">Reload</button>
      <div style="flex:1"></div>
      <div class="small">Connected to: <span id="currentServer">—</span></div>
    </div>

    <div style="margin-top:10px" class="small">
      <strong>Notes:</strong> Use a publicly reachable Wisp server (or your backend URL). If a site uses strict CSP or cross-origin restrictions, some features may be limited. Saved server is stored locally.
    </div>
  </div>

  <script>
    (function(){
      const wispInput = document.getElementById('wispUrl');
      const rawInput = document.getElementById('rawUrl');
      const goBtn = document.getElementById('go');
      const saveBtn = document.getElementById('saveServer');
      const openNew = document.getElementById('openNew');
      const frame = document.getElementById('targetFrame');
      const currentServer = document.getElementById('currentServer');
      const backBtn = document.getElementById('back');
      const forwardBtn = document.getElementById('forward');
      const reloadBtn = document.getElementById('reload');

      function normalizeServer(s){
        if(!s) return '';
        s = s.trim();
        if(!s) return '';
        try{
          const u = new URL(s);
          return u.origin;
        }catch(e){
          // try http
          try{ const u2 = new URL('https://' + s); return u2.origin; }catch(e){ return s; }
        }
      }

      function getSaved(){
        return localStorage.getItem('euph_wisp') || '';
      }
      function setSaved(v){
        localStorage.setItem('euph_wisp', v || '');
      }

      // load saved
      (()=>{
        const s = getSaved();
        if(s) wispInput.value = s;
        currentServer.textContent = s || 'local';
      })();

      saveBtn.addEventListener('click', ()=>{
        const srv = normalizeServer(wispInput.value);
        setSaved(srv);
        wispInput.value = srv;
        currentServer.textContent = srv || 'local';
        alert('Wisp server saved: ' + srv);
      });

      function buildProxyUrl(target){
        const srv = normalizeServer(getSaved()) || '';
        // client supports two modes:
        // 1) If saved server exists, request /proxy?url=... at that server
        // 2) If not, assume local backend under same origin: /proxy?url=...
        const base = srv || window.location.origin;
        try{
          // if user provided a proxied path already (starts with /proxy or /proxy//)
          if(/^\/proxy(\/.*)?/.test(target)) {
            // if target is /proxy//host/... keep as-is but prefix with base
            if(target.startsWith('/proxy/')) {
              return base + target;
            }
            return base + '/proxy?url=' + encodeURIComponent(target.replace(/^\/proxy\??/,''));
          }
          // full URL -> proxy at base
          const url = new URL(target, window.location.origin).href;
          return base + '/proxy?url=' + encodeURIComponent(url);
        }catch(e){
          // fallback
          return base + '/proxy?url=' + encodeURIComponent(target);
        }
      }

      goBtn.addEventListener('click', ()=>{
        const v = rawInput.value.trim();
        if(!v){
          alert('Enter a URL or proxied path');
          return;
        }
        const final = buildProxyUrl(v);
        frame.src = final;
      });

      openNew.addEventListener('click', ()=>{
        const v = rawInput.value.trim();
        if(!v) return alert('Enter url');
        const final = buildProxyUrl(v);
        window.open(final, '_blank');
      });

      backBtn.addEventListener('click', ()=>{ try{ frame.contentWindow.history.back(); }catch(e){ console.warn(e); }});
      forwardBtn.addEventListener('click', ()=>{ try{ frame.contentWindow.history.forward(); }catch(e){ console.warn(e); }});
      reloadBtn.addEventListener('click', ()=>{ frame.src = frame.src; });

      // keyboard shortcuts
      rawInput.addEventListener('keydown', (ev)=>{
        if(ev.key === 'Enter') goBtn.click();
      });

      // auto-connect sample
      const q = new URLSearchParams(location.search).get('url');
      if(q){
        rawInput.value = q;
        goBtn.click();
      }

      // small auto-detect: try detect backend health
      async function probe(){
        const srv = normalizeServer(getSaved()) || '';
        const probeUrl = (srv || window.location.origin) + '/_euph_debug/ping';
        try{
          const r = await fetch(probeUrl, {method:'GET', credentials:'include'});
          if(r.ok) currentServer.textContent = (srv||window.location.origin) + ' ✓';
          else currentServer.textContent = (srv||window.location.origin) + ' ✗';
        }catch(e){
          currentServer.textContent = (srv||window.location.origin) + ' ✗';
        }
      }
      setTimeout(probe, 600);
    })();
  </script>
</body>
</html>