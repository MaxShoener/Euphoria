<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Euphoria</title>
<style>
  :root{
    --bg:#0b0c0d;
    --panel:#0f1112;
    --muted:#9aa0a6;
    --accent:#2e7d32;
    --btn:#171819;
    --white:#ffffff;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  /* floating oval topbar */
  #topbar{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    top:12px;
    width:84%;
    max-width:1200px;
    background:var(--panel);
    border-radius:30px;
    padding:8px;
    display:flex;
    gap:8px;
    align-items:center;
    z-index:2147483647;
    box-shadow:0 8px 30px rgba(0,0,0,.6);
  }
  #topbar button{
    min-width:44px;
    height:40px;
    padding:0 10px;
    border-radius:12px;
    border:0;
    background:var(--btn);
    color:var(--white);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
  }
  #topbar button:hover{filter:brightness(1.15)}
  #address{
    flex:1;
    height:40px;
    border-radius:12px;
    border:0;
    padding:8px 12px;
    background:#151617;
    color:var(--white);
    font-size:14px;
    outline:none;
  }
  #goBtn{background:var(--accent);font-weight:600}
  #content{
    position:fixed;
    top:72px;
    left:6px;
    right:6px;
    bottom:6px;
    border-radius:8px;
    overflow:auto;
    background:#fff;
  }
  /* make proxied pages look contained (server injects base + topbar on proxied HTML).
     here we are a container for server response */
  #content > .frame{
    width:100%;
    min-height:100%;
    background:transparent;
    color:#000;
  }

  /* spinner overlay (does NOT cover topbar) */
  #spinnerOverlay{
    position:fixed;
    left:6px;
    right:6px;
    top:72px;
    bottom:6px;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2147483500;
    pointer-events:none; /* allow topbar usable even if spinner active */
  }
  .spinnerWrap{
    pointer-events:auto;
    background:rgba(0,0,0,0.45);
    border-radius:12px;
    padding:18px;
    display:flex;
    gap:12px;
    align-items:center;
  }
  .spinner{
    width:44px;height:44px;border-radius:50%;
    border:6px solid #eee;border-top-color:var(--accent);
    animation:spin 900ms linear infinite;
  }
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

  /* Suggest dropdown */
  #suggestBox{
    position:absolute;
    top:56px;
    left:140px;
    right:190px;
    background:#121314;
    color:var(--muted);
    border-radius:8px;
    box-shadow:0 8px 20px rgba(0,0,0,.5);
    max-height:220px;
    overflow:auto;
    display:none;
    z-index:2147483650;
    font-size:14px;
  }
  #suggestBox div{
    padding:8px 12px;
    cursor:pointer;
  }
  #suggestBox div:hover{background:#1a1b1c;color:#fff}
  /* small helpers */
  .hidden{display:none !important}
</style>
</head>
<body>
  <div id="topbar" role="toolbar" aria-label="Euphoria topbar">
    <button id="backBtn" title="Back">‚óÄ</button>
    <button id="forwardBtn" title="Forward">‚ñ∂</button>
    <button id="refreshBtn" title="Refresh">‚ü≥</button>
    <button id="homeBtn" title="Home">üè†</button>

    <div style="position:relative;flex:1;min-width:220px;">
      <input id="address" aria-label="Address bar" placeholder="Enter URL or search..." autocomplete="off" />
      <div id="suggestBox" role="listbox" aria-label="Suggestions"></div>
    </div>

    <button id="goBtn" title="Go">Go</button>
    <button id="fsBtn" title="Fullscreen">‚õ∂</button>
  </div>

  <div id="spinnerOverlay"><div class="spinnerWrap"><div class="spinner" aria-hidden="true"></div><div style="color:#fff">Loading‚Ä¶</div></div></div>

  <main id="content" aria-live="polite">
    <div class="frame" id="frameInner" style="padding:20px; box-sizing:border-box;">
      <h2 style="font-family:system-ui,Arial;">Welcome to Euphoria</h2>
      <p style="color:#333;max-width:720px;">Enter a site into the address bar above (e.g. <code>google.com</code>, <code>https://xbox.com</code>, or type a search). Euphoria will proxy the page and display it here. Redirects, links and assets are routed through the proxy so navigation stays inside Euphoria.</p>
    </div>
  </main>

<script>
(() => {
  const address = document.getElementById('address');
  const backBtn = document.getElementById('backBtn');
  const forwardBtn = document.getElementById('forwardBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const homeBtn = document.getElementById('homeBtn');
  const goBtn = document.getElementById('goBtn');
  const fsBtn = document.getElementById('fsBtn');
  const content = document.getElementById('frameInner');
  const spinnerOverlay = document.getElementById('spinnerOverlay');
  const suggestBox = document.getElementById('suggestBox');

  let historyStack = [];
  let historyIndex = -1;

  // Debounce for suggestions
  function debounce(fn, t=200){ let id; return (...a)=>{ clearTimeout(id); id=setTimeout(()=>fn(...a),t); }; }

  // Determine if input looks like a search (no dot or contains space)
  function isLikelySearch(s){
    if(!s) return true;
    if(s.indexOf(' ') !== -1) return true;
    if(/^https?:\/\//i.test(s)) return false;
    if(/\./.test(s)) return false;
    return true;
  }
  function normalizeInput(s){
    s = (s||'').trim();
    if(!s) return 'https://www.google.com';
    if(isLikelySearch(s)) return 'https://www.google.com/search?q=' + encodeURIComponent(s);
    if(/^https?:\/\//i.test(s)) return s;
    return 'https://' + s;
  }

  // show/hide spinner (does NOT disable topbar)
  function showSpinner(){ spinnerOverlay.style.display = 'flex'; }
  function hideSpinner(){ spinnerOverlay.style.display = 'none'; }

  // Load url via /proxy endpoint
  async function loadURL(url, push=true){
    showSpinner();
    try {
      const resp = await fetch('/proxy?url=' + encodeURIComponent(url), { credentials: 'include' });
      if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
      const html = await resp.text();
      // Put html into content container
      content.innerHTML = html;
      // keep a lightweight record in our history stack (url)
      if(push){
        historyStack = historyStack.slice(0, historyIndex + 1);
        historyStack.push(url);
        historyIndex = historyStack.length - 1;
      }
      // update address bar with canonical (final) URL
      address.value = url;
      // enable/disable nav buttons
      updateNavButtons();
      // content loaded ‚Äî ensure topbar elements in proxied page (server injects topbar too)
      // but our local topbar must remain usable ‚Äî ensure it's on top
      // Also attempt to focus address field if needed
      // Note: server rewrites links to point back to /proxy so simple anchor clicks will stay inside
    } catch (err) {
      content.innerHTML = `<div style="padding:24px;color:#900;background:#fff;border-radius:6px;"><strong>Error loading page:</strong><br>${String(err)}</div>`;
    } finally {
      // small delay so spinner visible on fast loads
      setTimeout(hideSpinner, 150);
    }
  }

  function updateNavButtons(){
    backBtn.disabled = historyIndex <= 0;
    forwardBtn.disabled = historyIndex >= historyStack.length - 1;
  }

  backBtn.addEventListener('click', () => {
    if(historyIndex > 0){
      historyIndex--;
      loadURL(historyStack[historyIndex], false);
    }
  });
  forwardBtn.addEventListener('click', () => {
    if(historyIndex < historyStack.length - 1){
      historyIndex++;
      loadURL(historyStack[historyIndex], false);
    }
  });
  refreshBtn.addEventListener('click', () => {
    if(historyIndex >= 0) loadURL(historyStack[historyIndex], false);
    else if(address.value) loadURL(normalizeInput(address.value), false);
  });
  homeBtn.addEventListener('click', () => loadURL('https://www.google.com'));

  goBtn.addEventListener('click', () => {
    const val = address.value.trim();
    // if user pasted /proxy?url= already, navigate to it
    if (/\/proxy\?url=/i.test(val)) { window.location.href = val; return; }
    const url = normalizeInput(val);
    loadURL(url);
  });
  address.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { goBtn.click(); }
    if (e.key === 'ArrowDown') {
      // focus first suggestion if visible
      const first = suggestBox.querySelector('div');
      if(first){ first.focus(); first.click(); }
    }
  });

  // fullscreen
  fsBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
    else document.exitFullscreen().catch(()=>{});
  });

  // Suggest box (autocomplete) using /suggest?q=...
  async function fetchSuggest(q){
    try {
      if(!q) { suggestBox.style.display='none'; return; }
      const r = await fetch('/suggest?q=' + encodeURIComponent(q));
      if(!r.ok) { suggestBox.style.display='none'; return; }
      const arr = await r.json();
      if(!Array.isArray(arr) || arr.length === 0){ suggestBox.style.display='none'; return; }
      suggestBox.innerHTML = '';
      arr.slice(0,10).forEach(item => {
        const div = document.createElement('div');
        div.textContent = item;
        div.tabIndex = 0;
        div.addEventListener('click', () => {
          address.value = item;
          suggestBox.style.display='none';
          goBtn.click();
        });
        div.addEventListener('keydown', (ev) => { if(ev.key === 'Enter'){ div.click(); }});
        suggestBox.appendChild(div);
      });
      // position/update
      suggestBox.style.display = 'block';
    } catch (e) {
      suggestBox.style.display = 'none';
    }
  }
  const debouncedSuggest = debounce((q) => fetchSuggest(q), 180);

  address.addEventListener('input', (e) => {
    const v = e.target.value || '';
    if(v.trim() === '') { suggestBox.style.display='none'; return; }
    debouncedSuggest(v);
  });
  // click-away hides suggest box
  document.addEventListener('click', (e) => {
    if(!e.target.closest('#topbar')) suggestBox.style.display='none';
  });

  // INITIAL: load google
  loadURL('https://www.google.com');

  // Expose some debug controls on window for dev
  window.__euphoria = {
    loadURL, historyStackRef: () => ({ historyStack, historyIndex }),
    clearHistory: () => { historyStack = []; historyIndex = -1; updateNavButtons(); }
  };
})();
</script>
</body>
</html>